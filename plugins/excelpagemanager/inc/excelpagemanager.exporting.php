<?php/** * [BEGIN_COT_EXT] * Hooks=ajax * [END_COT_EXT] *//** * Excel Page Importer / Exporter plugin * * @package excelpagemanager * @version 2.0.0 * @author esclkm * @copyright Copyright (c) esclkm 2008-2013 * @license BSD */defined('COT_CODE') or die('Wrong URL');require_once $cfg['plugins_dir'].'/excelpagemanager/lib/eiseXLSX/eiseXLSX.php';$configs = cot_import('configs', 'P', 'TXT');$xlsc = &$xlsx_export_config[$configs];if (!is_array($xlsc)){	cot_error('noxls');	exit();}$filename = $configs.date('_Y_m_d__H_i_s', $sys['now']).'.xlsx';$file = 'datas/users/'.$filename;$xlsx = new eiseXLSX($cfg['plugins_dir'].'/excelpagemanager/lib/eiseXLSX/templates/'.$xlsc['template']);//	$objPHPExcel = new PHPExcel();$c = cot_import('c', 'R', 'TXT');$in = cot_import('in', 'R', 'BOL') ? 1 : 0;$title = cot_import('title', 'R', 'TXT');$sorttype = cot_import('sorttype', 'R', 'ALP');$sortway = cot_import('sortway', 'R', 'ALP');$filter = cot_import('filter', 'R', 'ALP');$parser_list = cot_get_parsers();$sorttype = empty($sorttype) ? 'id' : $sorttype;$sqlsorttype = 'page_'.$sorttype;$sortway = empty($sortway) ? 'desc' : $sortway;$sqlsortway = $sortway;$filter = empty($filter) ? 'valqueue' : $filter;if ($in){	$catlist2 = cot_structure_children('page', $c);	$where['cat'] = "page_cat IN ('".implode("','", $catlist2)."')";}else{	$where['cat'] = "page_cat='".$db->prep($c)."'";}if (!empty($title)){	$where['title'] = "page_title LIKE '%".$db->prep($title)."%'";}if ($filter == 'valqueue'){	$where['state'] = "page_state=1 ";}elseif ($filter == 'validated'){	$where['state'] = "page_state<>1 ";}elseif ($filter == 'expired'){	$where['state'] = "page_begin > {$sys['now']} OR (page_expire <> 0 AND page_expire < {$sys['now']})";}/* === Hook === */foreach (cot_getextplugins('excelpagemanager.export.query') as $pl){	include $pl;}/* ===== */$where = ($where) ? 'WHERE '.implode(' AND ', $where) : '';$sqllist_rowset = $db->query("SELECT * FROM $db_pages $where ORDER BY $sqlsorttype $sqlsortway")->fetchAll();$ii = $xlsc['offset'];foreach ($sqllist_rowset as $pag){	foreach ($xlsc['colsexport'] as $key => $value)	{		$valxls = '';		if (isset($pag[$value['field']]))		{			$valxls = filterxlsx($pag[$value['field']], $value['type'], $value['value'], $value['default']);		}		$xlsx->data($key.$ii, $valxls);	}	$ii++;}if (is_array($xlsc['autoinsert'])){	foreach ($xlsc['autoinsert'] as $k => $v)	{		$xlsx->data($k, $v); // добавляем данные в ячейку A1 на ПЕРВОЙ странице. 'a1' - ячейка (колонка-ряд); 'Здесь A1' - контент ячейки (если не указан, ячейка очищается)	}}$xlsx->Output($file, "F"); // save the file header('Content-disposition: attachment; filename='.$filename);header('Content-type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header('Content-Length: '.filesize($file));header('Content-Transfer-Encoding: binary');header('Cache-Control: must-revalidate');header('Pragma: public');ob_clean();flush();readfile($file);